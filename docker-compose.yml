services:
  app-cpu:
    build: 
      context: .
      dockerfile: Dockerfile.gpu
      args:
        TARGET: cpu #cpu
    container_name: face-embedding-cpu
    command: "tail -f /dev/null"  # Keep the container running
    ports:
      - "5001:5000"
    volumes:
      - ./models:/app/models:ro  # Mount model files
      - ./images:/app/images:ro  # Mount image files
      - ./data:/app/data:ro  # Mount data files
      - ./src:/app/src:ro  # Mount source code
    environment:
      - FLASK_ENV=production
      - GUNICORN_WORKERS=4
    depends_on:
      - qdrant
    restart: unless-stopped
    networks:
      - face-network

  app:
    build: 
      context: .
      dockerfile: Dockerfile.gpu
      args:
        TARGET: gpu #cpu
    runtime: nvidia
    #image: nvidia/cuda:12.2.2-devel-ubuntu22.04
    container_name: face-embedding
    command: "tail -f /dev/null"  # Keep the container running
    ports:
      - "5000:5000"
    volumes:
      - ./models:/app/models:ro  # Mount model files
      - ./images:/app/images:ro  # Mount image files
      - ./data:/app/data:ro  # Mount data files
      - ./src:/app/src:ro  # Mount source code
      - /tmp/.X11-unix:/tmp/.X11-unix:rw  # For GUI applications
    environment:
      - FLASK_ENV=production
      - GUNICORN_WORKERS=4
      - USE_GPU=True
      - GPU_ID=0
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,video
      - DISPLAY=:0
      - MXNET_CUDNN_AUTOTUNE_DEFAULT=0

    depends_on:
      - qdrant
    restart: unless-stopped
    networks:
      - face-network

  qdrant:
    image: qdrant/qdrant:v1.11.0 #latest
    container_name: face-qdrant
    #command: "tail -f /dev/null"  # Keep the container running
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    networks:
      - face-network

  # Optional: nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: face-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - face-api
    restart: unless-stopped
    networks:
      - face-network
    profiles:
      - nginx

volumes:
  qdrant_storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/qdrant_storage

networks:
  face-network:
    driver: bridge
