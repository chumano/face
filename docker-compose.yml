services:
  face-api:
    build: 
      context: .
      dockerfile: Dockerfile
      args:
        TARGET: cpu
    container_name: face-embedding-api
    #command: "tail -f /dev/null"  # Keep the container running
    ports:
      - "5000:5000"
    volumes:
      - ./models:/app/models:ro  # Mount model files
      - ./images:/app/images:ro  # Mount image files
      - ./data:/app/data:ro  # Mount data files
    environment:
      - FLASK_ENV=production
      - GUNICORN_WORKERS=4
    depends_on:
      - qdrant
    restart: unless-stopped
    networks:
      - face-network

  qdrant:
    image: qdrant/qdrant:v1.11.0 #latest
    container_name: qdrant
    #command: "tail -f /dev/null"  # Keep the container running
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    networks:
      - face-network

  # Optional: nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: face-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - face-api
    restart: unless-stopped
    networks:
      - face-network
    profiles:
      - nginx

volumes:
  qdrant_storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/qdrant_storage

networks:
  face-network:
    driver: bridge
